{% extends "base.html" %}
{% block title %}Ticket #{{ ticket.id }}{% endblock %}
{% block content %}
<h1>Ticket #{{ ticket.id }} — {{ ticket.title }}</h1>
<p><strong>Status:</strong> {{ ticket.get_status_display }} |
   <strong>Priority:</strong> {{ ticket.get_priority_display }}</p>
<p><strong>Order ref:</strong> {{ ticket.order_reference }}</p>
<p>{{ ticket.description }}</p>

<p>
  <a role="button" href="{% url 'ticket_update' ticket.id %}">Edit</a>
  {% if user.is_staff %}
    <!-- Status transitions for agents/admins -->
    <a role="button" href="{% url 'ticket_transition' ticket.id 'IN_PROGRESS' %}">Mark In Progress</a>
    <a role="button" href="{% url 'ticket_transition' ticket.id 'RESOLVED' %}">Resolve</a>
    <a role="button" href="{% url 'ticket_transition' ticket.id 'CLOSED' %}">Close</a>
  {% endif %}
</p>

<h2>Activity</h2>
<ul>
  {% for e in ticket.events.all %}
    <li>
      <small>{{ e.created_at|date:"Y-m-d H:i" }}</small>
      {% if e.event_type == "COMMENT" %}
        <strong>{{ e.author }}</strong>: {{ e.message }}
      {% else %}
        Status changed: {{ e.from_status }} → {{ e.to_status }} by {{ e.author }}
      {% endif %}
    </li>
  {% empty %}
    <li>No activity yet.</li>
  {% endfor %}
</ul>

<h3>Add comment</h3>
<form method="post" action="{% url 'ticket_comment' ticket.id %}">
  {% csrf_token %}
  {{ comment_form.as_p }}
  <button type="submit">Post</button>
</form>
{% endblock %}